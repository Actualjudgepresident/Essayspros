/* auth.js
   Front end only demonstration of login, signup, and order storage.
   This is not secure and must be replaced by a server side system for production use.
*/
(function () {
  const KEY_USERS = "ep_users_v1";
  const KEY_SESSION = "ep_session_v1";
  const KEY_ORDERS = "ep_orders_v1";

  function load(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch {
      return fallback;
    }
  }

  function save(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  function normalizeEmail(email) {
    return String(email || "").trim().toLowerCase();
  }

  function getUsers() {
    return load(KEY_USERS, []);
  }

  function setUsers(users) {
    save(KEY_USERS, users);
  }

  function setSession(user) {
    save(KEY_SESSION, user);
  }

  function clearSession() {
    localStorage.removeItem(KEY_SESSION);
  }

  function getSession() {
    return load(KEY_SESSION, null);
  }

  function getOrdersAll() {
    return load(KEY_ORDERS, []);
  }

  function setOrdersAll(orders) {
    save(KEY_ORDERS, orders);
  }

  function ensureSeedOrders(email) {
    const all = getOrdersAll();
    const existing = all.filter(x => x.ownerEmail === email);

    if (existing.length > 0) return;

    const seed = [
      {
        id: "EP-1001",
        ownerEmail: email,
        title: "Research paper on operating systems scheduling",
        status: "In progress",
        due: "2026-02-01",
        instructions: "Focus on scheduling algorithms, include comparative analysis and citations."
      },
      {
        id: "EP-1002",
        ownerEmail: email,
        title: "Case study analysis for IT management",
        status: "Submitted",
        due: "2026-01-28",
        instructions: "Provide executive summary, risk analysis, and recommendations."
      }
    ];

    setOrdersAll(all.concat(seed));
  }

  function signup(email, password) {
    const e = normalizeEmail(email);
    if (!e) return { ok: false, message: "Email is required." };
    if (!password || password.length < 6) return { ok: false, message: "Password must be at least 6 characters." };

    const users = getUsers();
    if (users.some(u => u.email === e)) return { ok: false, message: "Account already exists. Please log in." };

    users.push({ email: e, password: String(password) });
    setUsers(users);

    const user = { email: e };
    setSession(user);
    ensureSeedOrders(e);

    return { ok: true, message: "Account created." };
  }

  function login(email, password) {
    const e = normalizeEmail(email);
    const users = getUsers();
    const match = users.find(u => u.email === e && u.password === String(password));
    if (!match) return { ok: false, message: "Invalid email or password." };

    const user = { email: e };
    setSession(user);
    ensureSeedOrders(e);

    return { ok: true, message: "Logged in." };
  }

  function ensureAccount(email, password) {
    const e = normalizeEmail(email);
    const users = getUsers();
    if (!users.some(u => u.email === e)) {
      users.push({ email: e, password: String(password) });
      setUsers(users);
    }
    ensureSeedOrders(e);
  }

  function logout() {
    clearSession();
  }

  function getUser() {
    return getSession();
  }

  function getOrders() {
    const user = getUser();
    if (!user) return [];
    return getOrdersAll().filter(x => x.ownerEmail === user.email);
  }

  window.Auth = {
    signup,
    login,
    logout,
    getUser,
    getOrders,
    ensureAccount
  };
})();
