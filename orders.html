<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orders | EssaysPros.com</title>

  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="stylesheet" href="/style.css" />

  <style>
    .pageMain{ padding: 26px 0 46px; }
    .panel{
      background:#ffffff;
      border:1px solid #dbeafe;
      border-radius:18px;
      padding:22px;
      box-shadow:0 10px 30px rgba(37,99,235,0.08);
    }
    .title{
      margin:0 0 10px;
      font-size:40px;
      font-weight:900;
      letter-spacing:-0.02em;
      color:#0b1b46;
    }
    .sub{
      margin:0 0 18px;
      color:#475569;
      font-weight:700;
      line-height:1.5;
    }
    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#ffffff;
      color:#475569;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#ffffff;
      color:#0f172a;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
      gap:8px;
    }
    .btnPrimary{
      border:0;
      background:#2563eb;
      color:#ffffff;
    }
    .btnDanger{
      border:0;
      background:#ef4444;
      color:#ffffff;
    }
    .empty{
      border:1px dashed rgba(15,23,42,.20);
      border-radius:16px;
      padding:22px;
      text-align:center;
      background:#ffffff;
    }
    .empty h2{
      margin:0 0 10px;
      font-size:22px;
      font-weight:900;
      color:#0f172a;
    }
    .empty p{
      margin:0 0 14px;
      color:#475569;
      font-weight:700;
    }
    .list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:14px;
      margin-top:14px;
    }
    .card{
      border:1px solid #dbeafe;
      border-radius:16px;
      padding:16px;
      background:#ffffff;
      box-shadow:0 10px 24px rgba(15,23,42,.06);
    }
    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .cardTitle{
      margin:0;
      font-weight:900;
      color:#0b1b46;
      letter-spacing:-0.01em;
      font-size:18px;
    }
    .meta{
      margin:6px 0 0;
      color:#475569;
      font-weight:700;
      font-size:13px;
      line-height:1.4;
    }
    .badge{
      border:1px solid #dbeafe;
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      background:#ffffff;
      color:#475569;
    }
    .badgeOk{ border-color: rgba(22,163,74,.30); color:#16a34a; background: rgba(22,163,74,.08); }
    .badgeWarn{ border-color: rgba(245,158,11,.35); color:#f59e0b; background: rgba(245,158,11,.10); }
    .badgeBad{ border-color: rgba(239,68,68,.35); color:#ef4444; background: rgba(239,68,68,.08); }
    .cardActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .note{
      display:none;
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e2e8f0;
      background:#f8fafc;
      color:#0f172a;
      font-weight:700;
      font-size:13px;
      text-align:center;
    }
    .adminBox{
      margin-top:18px;
      padding-top:18px;
      border-top:1px solid #dbeafe;
      display:none;
    }
    .field{ margin-top:10px; }
    .field label{
      display:block;
      font-size:13px;
      color:#475569;
      margin-bottom:6px;
      font-weight:700;
    }
    .field input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #dbeafe;
      outline:none;
      font-size:15px;
      background:#ffffff;
      color:#0f172a;
    }
    .adminList{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:900px){
      .title{ font-size:32px; }
      .list{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <header class="siteHeader">
    <div class="container headerRow">
      <a class="brand" href="/index.html">EssaysPros</a>
      <nav class="nav">
        <a href="/index.html">Home</a>
        <a class="active" href="/orders.html">Orders</a>
        <a href="/privacy.html">Privacy</a>
        <a href="/terms.html">Terms</a>
        <a href="/refund.html">Refund</a>
      </nav>
      <div class="headerActions">
        <a class="btnOutline" id="headerLogin" href="/auth/google/login.html">Log in</a>
        <a class="btnPrimary" id="headerSignup" href="/signup.html">Sign up</a>
      </div>
    </div>
  </header>

  <main class="pageMain">
    <section class="container">
      <div class="panel">
        <div class="row">
          <div>
            <h1 class="title">Orders</h1>
            <p class="sub" id="subText">Review your orders or start a new one.</p>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <span class="pill" id="authPill">Checking</span>
            <button class="btn btnPrimary" type="button" id="writeBtn">Write my paper</button>
            <button class="btn" type="button" id="refreshBtn">Refresh</button>
            <button class="btn" type="button" id="adminToggleBtn">Admin</button>
            <button class="btn btnDanger" type="button" id="logoutBtn" style="display:none;">Log out</button>
          </div>
        </div>

        <div class="note" id="note"></div>

        <div class="empty" id="signedOutBox" style="display:none;">
          <h2>Sign in required</h2>
          <p>To view your orders and place a new order, please sign in.</p>
          <a class="btn btnPrimary" id="goLoginBtn" href="/auth/google/login.html">Log in</a>
        </div>

        <div class="empty" id="emptyBox" style="display:none;">
          <h2>No orders yet</h2>
          <p>Start by creating your first order.</p>
          <button class="btn btnPrimary" type="button" id="writeBtn2">Write my paper</button>
        </div>

        <div id="ordersWrap" style="display:none;">
          <div class="list" id="ordersList"></div>
        </div>

        <div class="adminBox" id="adminBox">
          <h2 style="margin:0 0 10px; font-size:18px; font-weight:900; color:#0b1b46;">Admin panel</h2>
          <p class="sub" style="margin-bottom:10px;">
            This section requires server endpoints that list orders and accept solution uploads.
          </p>

          <div class="field">
            <label for="adminKey">Admin key</label>
            <input id="adminKey" placeholder="Enter admin key" />
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <button class="btn btnPrimary" type="button" id="adminLoadBtn">Load orders</button>
          </div>

          <div class="adminList" id="adminList"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="siteFooter">
    <div class="container footerRow">
      <div>
        <div class="brandSmall">EssaysPros</div>
        <div class="muted">Â© <span id="year"></span> EssaysPros.com. All rights reserved.</div>
      </div>
      <div class="footerLinks">
        <a href="/privacy.html">Privacy</a>
        <a href="/terms.html">Terms</a>
        <a href="/refund.html">Refund</a>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById("year").textContent = String(new Date().getFullYear());

    const authPill = document.getElementById("authPill");
    const subText = document.getElementById("subText");
    const note = document.getElementById("note");

    const signedOutBox = document.getElementById("signedOutBox");
    const emptyBox = document.getElementById("emptyBox");
    const ordersWrap = document.getElementById("ordersWrap");
    const ordersList = document.getElementById("ordersList");

    const writeBtn = document.getElementById("writeBtn");
    const writeBtn2 = document.getElementById("writeBtn2");
    const refreshBtn = document.getElementById("refreshBtn");

    const headerLogin = document.getElementById("headerLogin");
    const headerSignup = document.getElementById("headerSignup");
    const logoutBtn = document.getElementById("logoutBtn");

    const goLoginBtn = document.getElementById("goLoginBtn");

    const adminToggleBtn = document.getElementById("adminToggleBtn");
    const adminBox = document.getElementById("adminBox");
    const adminKey = document.getElementById("adminKey");
    const adminLoadBtn = document.getElementById("adminLoadBtn");
    const adminList = document.getElementById("adminList");

    let signedIn = false;
    let me = null;

    function showNote(message){
      note.textContent = message || "";
      note.style.display = message ? "block" : "none";
    }

    function setSignedOutUI(){
      signedIn = false;
      me = null;

      authPill.textContent = "Signed out";
      subText.textContent = "To view orders and place a new order, please sign in.";

      headerLogin.style.display = "inline-flex";
      headerSignup.style.display = "inline-flex";
      logoutBtn.style.display = "none";

      signedOutBox.style.display = "block";
      emptyBox.style.display = "none";
      ordersWrap.style.display = "none";
      ordersList.innerHTML = "";
    }

    function setSignedInUI(){
      signedIn = true;

      authPill.textContent = "Signed in";
      subText.textContent = "Review your orders or start a new one.";

      headerLogin.style.display = "none";
      headerSignup.style.display = "none";
      logoutBtn.style.display = "inline-flex";

      signedOutBox.style.display = "none";
    }

    function setReturnAfterAuth(url){
      localStorage.setItem("returnAfterAuth", url);
    }

    function gotoLoginFor(urlAfter){
      setReturnAfterAuth(urlAfter || "/orders.html");
      window.location.href = "/auth/google/login.html";
    }

    function gotoWrite(){
      if(!signedIn){
        gotoLoginFor("/write.html");
        return;
      }
      window.location.href = "/write.html";
    }

    writeBtn.addEventListener("click", gotoWrite);
    writeBtn2.addEventListener("click", gotoWrite);

    goLoginBtn.addEventListener("click", function(){
      setReturnAfterAuth("/orders.html");
    });

    adminToggleBtn.addEventListener("click", function(){
      adminBox.style.display = (adminBox.style.display === "block") ? "none" : "block";
    });

    async function fetchFirstOkJson(urls){
      for(const url of urls){
        try{
          const r = await fetch(url, { credentials: "include" });
          if(!r.ok) continue;
          const j = await r.json().catch(()=> null);
          if(j) return { url, json: j };
        }catch(e){
        }
      }
      return null;
    }

    async function detectAuth(){
      authPill.textContent = "Checking";
      showNote("");

      const candidates = [
        "/api/me",
        "/functions/api/me",
        "/.netlify/functions/api/me"
      ];

      const res = await fetchFirstOkJson(candidates);
      if(!res){
        setSignedOutUI();
        return false;
      }

      me = res.json;
      setSignedInUI();
      return true;
    }

    function badgeFor(order){
      const paid = order && order.paid === true;
      const status = String((order && order.status) || "").toLowerCase();

      if(paid) return { cls: "badge badgeOk", text: "Paid" };
      if(status.includes("submitted")) return { cls: "badge badgeWarn", text: "Submitted" };
      if(status.includes("created")) return { cls: "badge badgeWarn", text: "Created" };
      if(status.includes("completed")) return { cls: "badge badgeOk", text: "Completed" };
      if(status.includes("cancel")) return { cls: "badge badgeBad", text: "Canceled" };
      return { cls: "badge", text: order && order.status ? String(order.status) : "Pending" };
    }

    function safeText(v){
      return (v === null || v === undefined) ? "" : String(v);
    }

    function formatDate(iso){
      try{
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return safeText(iso);
        return d.toLocaleString();
      }catch(e){
        return safeText(iso);
      }
    }

    async function loadOrdersFromServer(){
      const endpoints = [
        "/api/orders",
        "/functions/api/orders",
        "/.netlify/functions/api/orders"
      ];

      const res = await fetchFirstOkJson(endpoints);
      if(!res) return null;

      const j = res.json;
      if(Array.isArray(j)) return j;
      if(j && Array.isArray(j.orders)) return j.orders;
      return null;
    }

    function loadOrdersFromLocal(){
      try{
        const raw = localStorage.getItem("orders");
        const data = raw ? JSON.parse(raw) : [];
        return Array.isArray(data) ? data : [];
      }catch(e){
        return [];
      }
    }

    function renderOrders(orders){
      ordersList.innerHTML = "";

      if(!orders || !orders.length){
        emptyBox.style.display = "block";
        ordersWrap.style.display = "none";
        return;
      }

      emptyBox.style.display = "none";
      ordersWrap.style.display = "block";

      const reversed = orders.slice().reverse();

      for(const o of reversed){
        const id = safeText(o.id || o.orderId || "");
        const createdAt = formatDate(o.createdAt || o.date || "");
        const subject = safeText(o.subjectShown || ((o.subject === "Other") ? o.subjectOther : o.subject));
        const assignmentType = safeText(o.assignmentType);
        const academicLevel = safeText(o.academicLevel);
        const language = safeText(o.language);
        const pages = safeText(o.pages);
        const words = safeText(o.words);
        const deadline = safeText(o.deadline);
        const paid = o && o.paid === true;

        const badge = badgeFor(o);

        const lines = [];
        if(id) lines.push("Order id: " + id);
        if(createdAt) lines.push("Created: " + createdAt);
        if(assignmentType) lines.push("Type: " + assignmentType);
        if(academicLevel) lines.push("Level: " + academicLevel);
        if(language) lines.push("Language: " + language);
        if(pages) lines.push("Pages: " + pages);
        if(words) lines.push("Words: " + words);
        if(deadline) lines.push("Deadline: " + deadline);
        if(paid) lines.push("Payment: Paid");

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML =
          '<div class="cardTop">' +
            '<div>' +
              '<p class="cardTitle">' + (subject || "Order") + "</p>" +
              '<p class="meta">' + lines.join("<br>") + "</p>" +
            "</div>" +
            '<span class="' + badge.cls + '">' + badge.text + "</span>" +
          "</div>" +
          '<div class="cardActions">' +
            '<button class="btn btnPrimary" type="button">Open</button>' +
          "</div>";

        const openBtn = card.querySelector("button");
        openBtn.addEventListener("click", function(){
          if(id) localStorage.setItem("activeOrderId", id);
          window.location.href = "/write.html";
        });

        ordersList.appendChild(card);
      }
    }

    async function refresh(){
      showNote("");

      const ok = await detectAuth();
      if(!ok) return;

      const serverOrders = await loadOrdersFromServer();
      if(serverOrders){
        renderOrders(serverOrders);
        showNote("");
        return;
      }

      const localOrders = loadOrdersFromLocal();
      renderOrders(localOrders);
      if(localOrders.length){
        showNote("Server orders endpoint was not found. Local orders were displayed instead.");
      }else{
        showNote("Server orders endpoint was not found. No local orders were found.");
      }
    }

    refreshBtn.addEventListener("click", refresh);

    logoutBtn.addEventListener("click", function(){
      showNote("Signing out requires a server endpoint. Clearing local session marker only.");
      localStorage.removeItem("auth");
      setSignedOutUI();
    });

    async function adminLoad(){
      try{
        showNote("");
        adminList.innerHTML = "";

        const key = String(adminKey.value || "").trim();
        if(!key){
          showNote("Admin key is required.");
          return;
        }

        const endpoints = [
          "/api/admin/orders",
          "/functions/api/admin/orders",
          "/.netlify/functions/api/admin/orders"
        ];

        let data = null;
        for(const url of endpoints){
          try{
            const r = await fetch(url, { headers: { "x-admin-key": key }, credentials: "include" });
            if(!r.ok) continue;
            const j = await r.json().catch(()=> null);
            if(j && Array.isArray(j.orders)) { data = j.orders; break; }
            if(Array.isArray(j)) { data = j; break; }
          }catch(e){
          }
        }

        if(!data){
          showNote("Admin orders endpoint was not found or access was denied.");
          return;
        }

        data.slice().reverse().forEach(function(o){
          const id = safeText(o.id || "");
          const subject = safeText(o.data && o.data.subjectShown ? o.data.subjectShown : (o.subjectShown || ""));
          const createdAt = safeText(o.createdAt || "");
          const paid = o && o.paid === true;

          const item = document.createElement("div");
          item.className = "adminItem";
          item.style.border = "1px solid #dbeafe";
          item.style.borderRadius = "14px";
          item.style.padding = "12px 14px";
          item.style.background = "#ffffff";

          const title = document.createElement("div");
          title.style.fontWeight = "900";
          title.style.color = "#0b1b46";
          title.style.marginBottom = "6px";
          title.textContent = "Order " + id;

          const meta = document.createElement("div");
          meta.className = "sub";
          meta.style.margin = "0 0 10px";
          meta.style.fontSize = "13px";
          meta.innerHTML =
            "Subject: " + (subject || "Not set") + "<br>" +
            "Created: " + (createdAt || "Not set") + "<br>" +
            "Payment: " + (paid ? "Paid" : "Not paid");

          const upLabel = document.createElement("div");
          upLabel.style.fontWeight = "800";
          upLabel.style.color = "#475569";
          upLabel.style.fontSize = "13px";
          upLabel.style.marginBottom = "6px";
          upLabel.textContent = "Upload solution files";

          const up = document.createElement("input");
          up.type = "file";
          up.multiple = true;

          const upBtn = document.createElement("button");
          upBtn.type = "button";
          upBtn.className = "btn btnPrimary";
          upBtn.style.marginTop = "10px";
          upBtn.textContent = "Upload solution";

          upBtn.addEventListener("click", async function(){
            try{
              const files = Array.from(up.files || []);
              if(!files.length){
                showNote("Select solution files.");
                return;
              }

              const form = new FormData();
              files.forEach(function(f){ form.append("solutionFiles", f); });

              const uploadEndpoints = [
                "/api/admin/orders/" + encodeURIComponent(id) + "/solution",
                "/functions/api/admin/orders/" + encodeURIComponent(id) + "/solution",
                "/.netlify/functions/api/admin/orders/" + encodeURIComponent(id) + "/solution"
              ];

              let okUpload = false;
              for(const u of uploadEndpoints){
                try{
                  const rr = await fetch(u, {
                    method: "POST",
                    headers: { "x-admin-key": key },
                    credentials: "include",
                    body: form
                  });
                  if(rr.ok){ okUpload = true; break; }
                }catch(e){
                }
              }

              if(!okUpload){
                showNote("Solution upload endpoint was not found or access was denied.");
                return;
              }

              showNote("Solution uploaded for order " + id + ".");
            }catch(e){
              showNote("Solution upload failed.");
            }
          });

          item.appendChild(title);
          item.appendChild(meta);
          item.appendChild(upLabel);
          item.appendChild(up);
          item.appendChild(upBtn);

          adminList.appendChild(item);
        });

        showNote("Admin orders loaded.");
      }catch(e){
        showNote("Admin orders could not be loaded.");
      }
    }

    adminLoadBtn.addEventListener("click", adminLoad);

    (function init(){
      setReturnAfterAuth("/orders.html");
      refresh();
    })();
  </script>
</body>
</html>
